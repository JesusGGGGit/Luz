{% extends 'base.html' %}
{% block content %}
<div class="card">
  <div class="card-header d-flex align-items-center gap-2">
    <i class="bi bi-{{ 'pencil-square' if bill else 'plus-lg' }}"></i>
    {{ 'Editar recibo' if bill else 'Nuevo recibo' }}
  </div>
  <div class="card-body">
    <form method="post" id="bill-form" data-initial-period="{{ selected_period or '' }}">
      <div class="row g-3">
        <div class="col-12">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="modeSwitch" name="mode" value="manual" {{ 'checked' if manual_mode else '' }}>
<label class="form-check-label" for="modeSwitch" style="color: var(--muted);">
  Capturar periodo manualmente
</label>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Periodo</label>
          <select class="form-control" name="period_option" data-lock-period="{{ '1' if lock_period else '0' }}" {{ 'disabled' if (manual_mode or lock_period) else '' }} {{ '' if (manual_mode or lock_period) else 'required' }}>
            <option value="" disabled {{ 'selected' if not selected_period }}>Selecciona un periodo</option>
            {% for val, label in bill_periods %}
              <option value="{{ val }}" {{ 'selected' if selected_period==val }}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Inicio (manual)</label>
          <input class="form-control" type="date" name="manual_start" {{ '' if manual_mode else 'disabled' }}>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Fin (manual)</label>
          <input class="form-control" type="date" name="manual_end" {{ '' if manual_mode else 'disabled' }}>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Monto total</label>
          <input class="form-control" id="amount_total" type="number" inputmode="decimal" step="0.01" name="amount_total" value="{{ bill.amount_total if bill else '' }}" required>
          <div class="form-text" id="price_per_kwh" aria-live="polite"></div>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-12 col-md-6">
          <label class="form-label">kWh del periodo</label>
          <input class="form-control" id="period_kwh" type="number" step="0.01" name="period_kwh" value="{{ '%.2f'|format(period_kwh_est) if period_kwh_est is defined else '' }}">
          <div class="form-text">Se precarga con un estimado (última - primera). Puedes ajustarlo.</div>
        </div>
      </div>
      <div class="mt-3">
        <label class="form-label">Notas</label>
        <input class="form-control" type="text" name="notes" value="{{ bill.notes if bill else '' }}">
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary flex-fill" type="submit"><i class="bi bi-check2 me-1"></i> Guardar</button>
        <a class="btn btn-secondary" href="{{ url_for('bills_list') }}">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% if period_readings is defined %}
<div class="card mt-3">
  <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-clipboard-data"></i> Lecturas en el periodo seleccionado</div>
  <div class="card-body table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>kWh</th>
          <th>Descripción</th>
        </tr>
      </thead>
      <tbody id="period-readings-body">
        {% for r in period_readings %}
        <tr>
          <td data-label="Fecha">{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td data-label="kWh">{{ r.kwh }}</td>
          <td data-label="Descripción">{{ r.description or '' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3" class="text-center">No hay lecturas dentro del periodo</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sel = document.querySelector('select[name="period_option"]');
    const kwhInput = document.getElementById('period_kwh');
    const amountInput = document.getElementById('amount_total');
    const ppEl = document.getElementById('price_per_kwh');
    const tableBody = document.querySelector('#period-readings-body');
    const modeSwitch = document.getElementById('modeSwitch');
    const manualStart = document.querySelector('input[name="manual_start"]');
    const manualEnd = document.querySelector('input[name="manual_end"]');
    function toggleMode(manual){
      if (!sel || !manualStart || !manualEnd) return;
  const LOCK_PERIOD = (sel?.dataset.lockPeriod === '1');
  sel.disabled = !!manual || LOCK_PERIOD;
      manualStart.disabled = !manual;
      manualEnd.disabled = !manual;
      if (!manual && sel.value) refreshPeriod(sel.value);
    }
    function updatePricePerKwh(){
      if (!ppEl) return;
      const a = parseFloat(amountInput?.value || '');
      const k = parseFloat(kwhInput?.value || '');
      if (isFinite(a) && isFinite(k) && k > 0) {
        const p = a / k;
        ppEl.textContent = `Costo aprox: $${p.toFixed(4)} por kWh`;
      } else {
        ppEl.textContent = '';
      }
    }
    async function refreshPeriod(val) {
      if (!val) return;
      try {
        const res = await fetch(`{{ url_for('bill_period_info') }}?val=${encodeURIComponent(val)}`);
        const data = await res.json();
        if (data.kwh_est !== undefined && kwhInput && (!kwhInput.value || kwhInput.value === '0' || kwhInput.dataset.autofill === '1')) {
          kwhInput.value = (Math.round(data.kwh_est * 100) / 100).toFixed(2);
          kwhInput.dataset.autofill = '1';
        }
        if (Array.isArray(data.readings) && tableBody) {
          tableBody.innerHTML = data.readings.map(r => `
            <tr>
              <td data-label="Fecha">${r.created_at.replace('T',' ')}</td>
              <td data-label="kWh">${r.kwh}</td>
              <td data-label="Descripción">${r.description || ''}</td>
            </tr>
          `).join('') || '<tr><td colspan="3" class="text-center">No hay lecturas dentro del periodo</td></tr>';
        }
        updatePricePerKwh();
      } catch (e) { /* no-op */ }
    }
    if (sel) {
      sel.addEventListener('change', (e) => refreshPeriod(e.target.value));
      const initial = document.getElementById('bill-form')?.dataset.initialPeriod;
      if (initial) {
        refreshPeriod(initial);
      } else if (!modeSwitch?.checked) {
        refreshPeriod(sel.value);
      }
    }
    modeSwitch?.addEventListener('change', (e) => toggleMode(e.target.checked));
    toggleMode(modeSwitch?.checked);
    amountInput?.addEventListener('input', updatePricePerKwh);
    kwhInput?.addEventListener('input', () => { kwhInput.dataset.autofill = '0'; updatePricePerKwh(); });
    updatePricePerKwh();
  });
</script>
{% endblock %}
