{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">Estadísticas</h3>
<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-lightning-charge"></i> kWh registrados</div>
      <div class="card-body">
        <canvas id="readingsChart" height="140"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-receipt"></i> Facturación (recibos)</div>
      <div class="card-body">
        <canvas id="billsChart" height="140"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-currency-dollar"></i> Costo promedio por kWh por periodo</div>
  <div class="card-body table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Periodo</th>
          <th>kWh en periodo</th>
          <th>Monto</th>
          <th>Costo promedio por kWh</th>
        </tr>
      </thead>
      <tbody>
        {% for row in period_costs %}
        <tr>
          <td data-label="Periodo">{{ row.label }}</td>
          <td data-label="kWh en periodo">{{ '%.2f'|format(row.total_kwh) }}</td>
          <td data-label="Monto">${{ '%.2f'|format(row.amount) }}</td>
          <td data-label="Costo promedio por kWh">
            {% if row.avg_cost is not none %}
              ${{ '%.4f'|format(row.avg_cost) }}
            {% else %}
              N/D
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script type="application/json" id="readings-data">{{ readings_data | tojson | safe }}</script>
<script type="application/json" id="bills-data">{{ bills_data | tojson | safe }}</script>
<script>
  const readingsData = JSON.parse(document.getElementById('readings-data').textContent);
  const billsData = JSON.parse(document.getElementById('bills-data').textContent);
  new Chart(document.getElementById('readingsChart'), {
    type: 'line',
    data: {
      labels: readingsData.labels,
      datasets: [{
        label: 'kWh',
        data: readingsData.kwh,
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        tension: 0.2,
        fill: true,
      }]
    },
    options: {
      maintainAspectRatio: false,
      scales: { x: { ticks: { color: '#9db0cf' } }, y: { ticks: { color: '#9db0cf' } } },
      plugins: { legend: { labels: { color: '#e8eef9' } } }
    }
  });
  new Chart(document.getElementById('billsChart'), {
    type: 'bar',
    data: {
      labels: billsData.labels,
      datasets: [{
        label: 'Monto $',
        data: billsData.amounts,
        backgroundColor: 'rgba(255, 99, 132, 0.5)'
      }]
    },
    options: {
      maintainAspectRatio: false,
      scales: { x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0, color: '#9db0cf' } }, y: { ticks: { color: '#9db0cf' } } },
      plugins: { legend: { labels: { color: '#e8eef9' } } }
    }
  });
</script>
{% endblock %}
